<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Simulador Financeiro</title>
  <style>
    body { font-family: sans-serif; max-width: 400px; margin: 2rem auto; padding: 0 1rem; }
    h1 { text-align: center; }
    label { display: block; margin: 1rem 0 0.25rem; }
    input, select, button { width: 100%; padding: .5rem; font-size: 1rem; }
    .hidden { display: none; }
    .result { margin-top: 1.5rem; background: #f9f9f9; padding: .75rem; border-radius: 6px; }
    .small { font-size: .85rem; color: #555; margin-top: .25rem; }
  </style>
</head>
<body>
  <h1>Simulador Financeiro</h1>

  <label>Pre√ßo √† vista (R$):
    <input id="v0" type="number" step="0.01" placeholder="Ex: 469.90">
  </label>

  <label>Quantidade de parcelas:
    <select id="n_select">
      <option value="">‚Äî selecione ‚Äî</option>
      <option value="1">1</option><option value="2">2</option><option value="3">3</option>
      <option value="4">4</option><option value="5">5</option><option value="6">6</option>
      <option value="7">7</option><option value="8">8</option><option value="9">9</option>
      <option value="10">10</option><option value="11">11</option><option value="12">12</option>
      <option value="other">Outro</option>
    </select>
  </label>

  <label id="label_n_custom" class="hidden">Digite o n√∫mero de parcelas:
    <input id="n_custom" type="number" min="1" placeholder="Ex: 18">
  </label>

  <label>Valor da parcela (R$):
    <input id="p" type="number" step="0.01" placeholder="Ex: 73.42">
  </label>

  <label>Rendimento (% do CDI):
    <input id="cdipercent" type="number" step="0.1" value="100">
  </label>
  <div class="small">
    CDI mensal atual: <span id="cdi_valor">‚Äî</span>
  </div>

  <button onclick="calc()">Calcular</button>
  <div class="result" id="res"></div>

  <script>
    // Controle do campo ‚ÄúOutro‚Äù de parcelas
    document.getElementById('n_select').addEventListener('change', function(e) {
      document.getElementById('label_n_custom')
        .classList.toggle('hidden', e.target.value !== 'other');
    });

    // Vari√°vel global para guardar o CDI mensal
    let cdiMensal = NaN;

    // Busca CDI di√°rio e converte para mensal (~21 dias √∫teis)
    async function fetchCDI() {
      const el = document.getElementById('cdi_valor');
      el.textContent = 'carregando‚Ä¶';
      try {
        const resp = await fetch('https://brasilapi.com.br/api/cdi/v1');
        if (!resp.ok) throw new Error('status ' + resp.status);
        const json = await resp.json();
        const diario = parseFloat(json.valor);
        cdiMensal = Math.pow(1 + diario, 21) - 1;
        el.textContent = (cdiMensal * 100).toFixed(2) + '%';
      } catch (err) {
        console.error('Erro ao buscar CDI:', err);
        el.textContent = 'n√£o dispon√≠vel';
      }
    }
    window.addEventListener('load', fetchCDI);

    function calc() {
      const V0 = parseFloat(document.getElementById('v0').value);
      let n = document.getElementById('n_select').value;
      if (n === 'other') {
        n = parseInt(document.getElementById('n_custom').value, 10);
      } else {
        n = parseInt(n, 10);
      }
      const P = parseFloat(document.getElementById('p').value);
      const pct = parseFloat(document.getElementById('cdipercent').value);
      const r = cdiMensal * (pct / 100);

      // Valida√ß√£o dos campos
      if (isNaN(V0) || !n || isNaN(P) || isNaN(r)) {
        document.getElementById('res').innerHTML =
          '<p style="color:red">Preencha todos os campos corretamente.</p>';
        return;
      }

      // C√°lculo m√™s a m√™s
      const F = P * n;
      let juros = 0, pago = 0;
      for (let i = 0; i < n; i++) {
        pago += P;
        juros += Math.max(F - pago, 0) * r;
      }
      const CL = F - juros;
      const decisao = CL > V0
        ? 'üëâ Melhor: Pagar √† vista'
        : 'üëâ Melhor: Parcelar e investir';

      // Mostrar resultados
      document.getElementById('res').innerHTML =
        `<p>Total financiado: R$ ${F.toFixed(2)}</p>` +
        `<p>Juros totais: R$ ${juros.toFixed(2)}</p>` +
        `<p>Custo l√≠quido: R$ ${CL.toFixed(2)}</p>` +
        `<p><strong>${decisao}</strong></p>`;
    }
  </script>
</body>
</html>
