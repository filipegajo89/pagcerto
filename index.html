<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PagCerto</title>
  <!-- Google Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --color-bg: #f0f2f5;
      --color-card: #ffffff;
      --color-primary: #00214D;
      --color-accent: #FFB400;
      --color-text: #333333;
      --color-border: #cccccc;
      --border-radius: 8px;
      --box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      --field-height: 3rem;
      --logo-size: 80px;
      --input-padding: 0.75rem;
    }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: var(--color-bg); color: var(--color-text); font-family: 'Roboto', sans-serif; }
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--color-primary);
      padding: 2rem 1rem;
      border-bottom-left-radius: var(--border-radius);
      border-bottom-right-radius: var(--border-radius);
    }
    .logo {
      width: calc(var(--logo-size) * 1.2);
      height: calc(var(--logo-size) * 1.2);
      object-fit: contain;
      margin: 0 auto 0.5rem;
    }
    h1 {
      margin: 0;
      font-weight: 500;
      font-size: 2rem;
      color: var(--color-card);
    }
    .card { background: var(--color-card); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 1.5rem; margin: 1rem; }
    .form-row { display: flex; flex-wrap: wrap; gap: 1rem; }
    .form-row > label { flex: 1 1 100%; }
    @media (min-width: 500px) { .form-row > label { flex: 1 1 48%; } }
    label { display: flex; flex-direction: column; font-size: 0.9rem; color: var(--color-primary); }
    label > span { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; }
    label .material-icons { font-size: 1.25rem; color: var(--color-primary); }
    input, select, button {
      height: var(--field-height);
      width: 100%;
      font-size: 1rem;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      transition: border 0.2s ease;
    } height: var(--field-height); width: 100% !important; font-size: 1rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); transition: border 0.2s ease; }
    input:focus, select:focus { outline: none; border-color: var(--color-primary); }
    select { padding: 0 var(--input-padding); margin-top: 0.25rem; }
    button { background: var(--color-primary); color: #fff; border: none; cursor: pointer; font-weight: 500; margin-top: 1rem; width: 100%; font-size: 1rem; border-radius: var(--border-radius); transition: background 0.2s ease; }
    button:hover { background: var(--color-accent); }
    .input-group {
      position: relative;
      width: 100%;
      height: var(--field-height);
    }
    .input-group .prefix, .input-group .input-group .suffix { right: 0.25rem; }
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      color: var(--color-text);
      font-weight: 500;
      pointer-events: none;
    } right: 0.25rem; }
    .input-group .prefix { left: var(--input-padding); } left: var(--input-padding); }
    .suffix { right: 0.5rem; } }
    input.with-prefix {
      padding-left: 2.5rem;
      padding-right: var(--input-padding);
    }
    /* reduzir espaço à direita para % ficar mais próximo */
    input.with-suffix {
      padding-right: 2.5rem;
      padding-left: var(--input-padding);
    }
    .small { font-size: 0.85rem; color: #555; margin-top: 0.5rem; }
    .result p { margin: 0.75rem 0; line-height: 1.4; }
    .error { color: #e53935; font-weight: 500; }
    .hidden { display: none !important; }
    /* Override para prefix/suffix dentro do campo */
  .input-group {
    display: flex;
    align-items: center;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    height: var(--field-height);
    padding: 0 0.5rem;
    background: var(--color-card);
  }
  .input-group input {
    border: none !important;
    outline: none;
    height: 100%;
    flex: 1;
    padding: 0;
    margin: 0;
    font-size: 1rem;
  }
  .input-group .prefix,
  .input-group .suffix {
    position: static;
    transform: none;
    margin: 0 0.25rem;
    visibility: visible;
  }
</style>
</head>
<body>
  <header>
    <img src="favicon.png" alt="PagCerto Logo" class="logo">
    <h1>PagCerto</h1>
  </header>

  <div class="card">
    <div class="form-row">
      <label>
        <span><i class="material-icons">attach_money</i>Preço à vista:</span>
        <div class="input-group">
          <span class="prefix">R$</span>
          <input id="v0" type="text" class="with-prefix" placeholder="1.000,00" data-currency>
        </div>
      </label>

      <label>
        <span><i class="material-icons">payment</i>Quantidade de parcelas:</span>
        <select id="n_select" inputmode="numeric" pattern="\d*">
          <option value="">— selecione —</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8</option><option value="9">9</option>
          <option value="10">10</option><option value="11">11</option><option value="12">12</option>
          <option value="other">Outra</option>
        </select>
      </label>

      <label id="label_n_custom" class="hidden">
        <span><i class="material-icons">edit</i>Digite o número de parcelas:</span>
        <input id="n_custom" type="text" inputmode="numeric" pattern="\d*">
      </label>

      <label>
        <span><i class="material-icons">view_module</i>Valor da parcela:</span>
        <div class="input-group">
          <span class="prefix">R$</span>
          <input id="p" type="text" class="with-prefix" placeholder="73,42" data-currency>
        </div>
      </label>

      <label>
        <span><i class="material-icons">trending_up</i>Rendimento (% do CDI):</span>
        <div class="input-group">
          <input id="cdipercent" type="text" class="with-suffix" placeholder="100" inputmode="numeric" pattern="\d*">
          <span class="suffix">%</span>
        </div>
      </label>
    </div>
    <div class="small">CDI mensal atual: <span id="cdi_valor">—</span></div>
    <button id="btnCalc">Calcular</button>
  </div>

  <div class="card">
    <div class="result" id="res"></div>
  </div>

  <script>
    // Toggle campo "Outra"
    const nSelect = document.getElementById('n_select');
    const labelNCustom = document.getElementById('label_n_custom');
    function toggleNCustom() { labelNCustom.classList.toggle('hidden', nSelect.value !== 'other'); }
    nSelect.addEventListener('change', toggleNCustom);
    window.addEventListener('load', toggleNCustom);

    // Formatação de campos numéricos
    document.querySelectorAll('[data-currency]').forEach(input => {
      input.setAttribute('inputmode','decimal');
      input.addEventListener('input', () => {
        input.value = input.value.replace(/[^0-9,\.]/g, '');
      });
      input.addEventListener('blur', () => {
        const v = input.value.replace(/\./g,'').replace(',', '.');
        const num = parseFloat(v);
        if (!isNaN(num)) input.value = num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      });
      input.addEventListener('focus', () => {
        input.value = input.value.replace(/\./g,'').replace(',', '.');
      });
      input.addEventListener('input', () => {
        const prefix = input.parentElement.querySelector('.prefix');
        prefix.style.visibility = input.value.trim() ? 'visible' : 'hidden';
      });
    });

    // Restringir apenas números no n_custom e cdipercent
    document.getElementById('n_custom').addEventListener('input', e => { e.target.value = e.target.value.replace(/\D/g, ''); });
    document.getElementById('cdipercent').addEventListener('input', e => { e.target.value = e.target.value.replace(/\D/g, ''); });

    // Buscar CDI
    let cdiMensal = NaN;
    async function fetchCDI() {
      const el = document.getElementById('cdi_valor'); el.textContent = 'carregando…';
      try {
        const resp = await fetch('https://api.bcb.gov.br/dados/serie/bcdata.sgs.12/dados/ultimos/1?formato=json');
        if (!resp.ok) throw new Error(resp.status);
        const data = await resp.json();
        const diario = parseFloat(data[0].valor.replace(',', '.')) / 100;
        cdiMensal = Math.pow(1 + diario, 21) - 1;
        el.textContent = (cdiMensal * 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) + '%';
      } catch (err) { el.textContent = 'não disponível'; console.error('Erro CDI:', err); }
    }
    window.addEventListener('load', fetchCDI);

    // Cálculo
    document.getElementById('btnCalc').addEventListener('click', () => {
      const rawV0 = document.getElementById('v0').value.replace(/\./g,'').replace(',', '.').trim();
      const rawP  = document.getElementById('p').value.replace(/\./g,'').replace(',', '.').trim();
      const V0 = parseFloat(rawV0); const P = parseFloat(rawP);
      let n = nSelect.value === 'other' ? parseInt(document.getElementById('n_custom').value, 10) : parseInt(nSelect.value, 10);
      const pct = parseFloat(document.getElementById('cdipercent').value);
      const r = cdiMensal * (pct / 100);
      const resEl = document.getElementById('res');
      if (isNaN(V0) || !n || isNaN(P) || isNaN(r)) { resEl.innerHTML = '<p class="error">Preencha todos os campos corretamente.</p>'; return; }
      const F = P * n; let juros = 0, pago = 0;
      for (let i = 0; i < n; i++) { pago += P; juros += Math.max(F - pago, 0) * r; }
      const CL = F - juros;
      const decisao = CL > V0 ? '👉 Melhor: Pagar à vista' : '👉 Melhor: Parcelar e investir';
      resEl.innerHTML =
        `<p><strong>Total parcelado:</strong> R$ ${F.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>` +
        `<p><strong>Rendimento total:</strong> R$ ${juros.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>` +
        `<p><strong>Custo líquido:</strong> R$ ${CL.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>` +
        `<p style=\"margin-top:1rem;\"><strong>${decisao}</strong></p>`;
    });
  </script>
</body>
</html>
