<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PagCerto</title>
  <!-- Google Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Poppins:wght@600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --color-bg: #f0f2f5;
      --color-card: #ffffff;
      --color-primary: #142633;
      --color-gradient-from: #142633;
      --color-gradient-to: #1e3248;
      --color-accent: #FFB400;
      --color-text: #333333;
      --color-border: #d1d5db;
      --border-radius: 12px;
      --box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      --field-height: 3rem;
      --logo-size: 80px;
      --input-padding: 0.75rem;
    }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: var(--color-bg); color: var(--color-text); font-family: 'Roboto', sans-serif; }
    header {
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, var(--color-gradient-from), var(--color-gradient-to));
      padding: 2.5rem 1rem;
      border-bottom-left-radius: var(--border-radius);
      border-bottom-right-radius: var(--border-radius);
    }
    .logo { width: var(--logo-size); height: var(--logo-size); object-fit: contain; }
    .card {
      background: var(--color-card);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 2rem;
      margin: 1rem;
    }
    h2 {
      font-family: 'Poppins', sans-serif;
      font-size: 1.25rem;
      margin-bottom: 0.75rem;
      color: var(--color-primary);
    }
    .form-row { display: flex; flex-wrap: wrap; gap: 1rem; }
    .form-row > label { flex: 1 1 100%; }
    @media (min-width: 500px) { .form-row > label { flex: 1 1 48%; } }
    label { display: flex; flex-direction: column; font-size: 1rem; color: var(--color-primary); }
    label > span { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
    label .material-icons { font-size: 1.5rem; }
    .input-group {
      display: flex;
      align-items: center;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      height: var(--field-height);
      width: 100%;
      padding: 0 0.75rem;
      background: var(--color-card);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .input-group:focus-within {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px rgba(20, 38, 51, 0.2);
    }
    .input-group input {
      border: none;
      outline: none;
      height: 100%;
      flex: 1;
      padding: 0;
      font-size: 1rem;
    }
    .input-group input::placeholder {
      color: #999;
      font-style: italic;
    }
    .input-group .prefix,
    .input-group .suffix {
      margin: 0 0.5rem;
      color: var(--color-text);
      font-weight: 500;
    }
    select, button {
      height: var(--field-height);
      width: 100%;
      font-size: 1rem;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    select:focus, button:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(20, 38, 51, 0.2); }
    select { padding: 0 var(--input-padding); margin-top: 0.25rem; }
    button {
      background: var(--color-primary);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
      margin-top: 1rem;
      border-radius: var(--border-radius);
      transition: background 0.2s, transform 0.1s;
    }
    button:hover { background: #0d1f3a; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    button:active { transform: scale(0.98); }
    .small { font-size: 0.9rem; color: #555; margin-top: 0.5rem; }
    .result p { margin: 0.75rem 0; line-height: 1.4; font-size: 1.125rem; font-weight: 500; }
    .error { color: #e53935; font-weight: 500; }
    .hidden { display: none !important; }
    #chart-line, #chart-bar, #chart-donut {
      max-width: 100%;
      height: 300px;
      opacity: 0;
      animation: fadeIn 0.6s forwards;
    }
    @keyframes fadeIn { to { opacity: 1; } }
  </style>
</head>
<body>
  <header>
    <img src="favicon.png" alt="PagCerto Logo" class="logo">
  </header>

  <div class="card">
    <div class="form-row">
      <label>
        <span><i class="material-icons">attach_money</i>PreÃ§o Ã  vista:</span>
        <div class="input-group">
          <span class="prefix">R$</span>
          <input id="v0" type="text" placeholder="1.000,00" data-currency>
        </div>
      </label>
      <label>
        <span><i class="material-icons">payment</i>Quantidade de parcelas:</span>
        <select id="n_select">
          <option value="">â€” selecione â€”</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8</option><option value="9">9</option>
          <option value="10">10</option><option value="11">11</option><option value="12">12</option>
          <option value="other">Outra</option>
        </select>
      </label>
      <label id="label_n_custom" class="hidden">
        <span><i class="material-icons">edit</i>Digite o nÃºmero de parcelas:</span>
        <div class="input-group">
          <input id="n_custom" type="text" inputmode="numeric" placeholder="Ex: 18">
        </div>
      </label>
      <label>
        <span><i class="material-icons">view_module</i>Valor da parcela:</span>
        <div class="input-group">
          <span class="prefix">R$</span>
          <input id="p" type="text" placeholder="73,42" data-currency>
        </div>
      </label>
      <label>
        <span><i class="material-icons">trending_up</i>Rendimento (% do CDI):</span>
        <div class="input-group">
          <input id="cdipercent" type="text" placeholder="100" inputmode="numeric">
          <span class="suffix">%</span>
        </div>
      </label>
    </div>
    <div class="small">CDI mensal atual: <span id="cdi_valor">â€”</span></div>
    <button id="btnCalc">Calcular</button>
  </div>

  <div class="card hidden" id="resCard"><div class="result" id="res"></div></div>
  <div class="card hidden" id="lineCard"><h2>Crescimento do Saldo</h2><div id="chart-line"></div></div>
  <div class="card hidden" id="barCard"><h2>Comparativo de Custos</h2><div id="chart-bar"></div></div>
  <div class="card hidden" id="donutCard"><h2>ComposiÃ§Ã£o de Juros</h2><div id="chart-donut"></div></div>

  <!-- ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script>
    // Toggle campo "Outra"
    const nSelect = document.getElementById('n_select');
    const labelNCustom = document.getElementById('label_n_custom');
    function toggleNCustom() { labelNCustom.classList.toggle('hidden', nSelect.value !== 'other'); }
    nSelect.addEventListener('change', toggleNCustom);
    window.addEventListener('load', toggleNCustom);

        // FormataÃ§Ã£o de campos numÃ©ricos
    document.querySelectorAll('[data-currency]').forEach(input => {
      // Permitir apenas dÃ­gitos e vÃ­rgula
      input.setAttribute('inputmode','decimal');
      input.addEventListener('input', () => {
        input.value = input.value.replace(/[^0-9,]/g, '');
      });
      // Ao perder foco, formata em pt-BR sem alterar o valor digitado
      input.addEventListener('blur', () => {
        let val = input.value.trim().replace(/[^0-9,]/g, '');
        if (!val.includes(',')) {
          val = val + ',00';
        } else {
          let [intPart, dec] = val.split(',');
          if (!dec) dec = '00';
          else if (dec.length === 1) dec = dec + '0';
          dec = dec.slice(0,2);
          val = intPart + ',' + dec;
        }
        // Aplica separador de milhar
        const [intPart, decPart] = val.split(',');
        const formattedInt = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        input.value = formattedInt + ',' + (decPart || '00');
      });
      // Ao focar, remove a formataÃ§Ã£o
      input.addEventListener('focus', () => {
        input.value = input.value.replace(/\./g, '').replace(',', ',');
      });
    });

    // Apenas nÃºmeros no campo "outra parcela" e no % do CDI
    document.getElementById('n_custom')
      .addEventListener('input', e => e.target.value = e.target.value.replace(/\D/g, ''));
    document.getElementById('cdipercent')
      .addEventListener('input', e => e.target.value = e.target.value.replace(/\D/g, ''));


    // Buscar CDI
    let cdiMensal = NaN;
    async function fetchCDI() {
      const el = document.getElementById('cdi_valor'); el.textContent = 'carregandoâ€¦';
      try {
        const resp = await fetch('https://api.bcb.gov.br/dados/serie/bcdata.sgs.12/dados/ultimos/1?formato=json');
        if (!resp.ok) throw new Error(resp.status);
        const data = await resp.json();
        const diario = parseFloat(data[0].valor.replace(',', '.')) / 100;
        cdiMensal = Math.pow(1 + diario, 21) - 1;
        el.textContent = (cdiMensal * 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) + '%';
      } catch (err) { el.textContent = 'nÃ£o disponÃ­vel'; console.error(err); }
    }
    window.addEventListener('load', fetchCDI);

    // CÃ¡lculo e GrÃ¡ficos
    document.getElementById('btnCalc').addEventListener('click', () => {
      const rawV0 = document.getElementById('v0').value.replace(/\./g,'').replace(',', '.').trim();
      const rawP  = document.getElementById('p').value.replace(/\./g,'').replace(',', '.').trim();
      const V0 = parseFloat(rawV0), P = parseFloat(rawP);
      let n = nSelect.value === 'other' ? parseInt(document.getElementById('n_custom').value, 10) : parseInt(nSelect.value, 10);
      const pct = parseFloat(document.getElementById('cdipercent').value);
      const r = cdiMensal * (pct/100);
      const resEl = document.getElementById('res');
      if (isNaN(V0)||!n||isNaN(P)||isNaN(r)) { resEl.innerHTML = '<p class="error">Preencha todos os campos corretamente.</p>'; return; }
      const F = P*n; let juros=0, pago=0;
      for(let i=0;i<n;i++){ pago+=P; juros+=Math.max(F-pago,0)*r; }
      const CL = F-juros;
      resEl.innerHTML =
        `<p><strong>Total parcelado:</strong> R$ ${F.toLocaleString('pt-BR',{minimumFractionDigits:2})}</p>`+
        `<p><strong>Rendimento total:</strong> R$ ${juros.toLocaleString('pt-BR',{minimumFractionDigits:2})}</p>`+
        `<p><strong>Custo lÃ­quido:</strong> R$ ${CL.toLocaleString('pt-BR',{minimumFractionDigits:2})}</p>`+
        `<p style="margin-top:1rem;"><strong>${CL>V0? 'ðŸ‘‰ Melhor: Pagar Ã  vista':'ðŸ‘‰ Melhor: Parcelar e investir'}</strong></p>`;

      // Dados para grÃ¡ficos
      const saldos = [], meses = [];
      let acumulado = 0;
      for(let i=1;i<=n;i++){
        acumulado +=Math.max(F-(P*i),0)*r;
        saldos.push(parseFloat(acumulado.toFixed(2)));
        meses.push(`MÃªs ${i}`);
      }
      // Line Chart
      ApexCharts.exec('line-chart','destroy');
      new ApexCharts(document.querySelector('#chart-line'),{
        chart:{id:'line-chart',type:'line',toolbar:{show:false}},
        series:[{name:'Saldo Investido',data:saldos}],
        xaxis:{categories:meses},stroke:{curve:'smooth',width:2},markers:{size:4},colors:['#00214D'],grid:{borderColor:'#e0e0e0'},tooltip:{y:{formatter:v=>v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}}
      }).render();
      // Bar Chart
      ApexCharts.exec('bar-chart','destroy');
      new ApexCharts(document.querySelector('#chart-bar'),{
        chart:{id:'bar-chart',type:'bar',toolbar:{show:false}},
        series:[{name:'Ã€ vista',data:[V0]},{name:'Parcelado (lÃ­quido)',data:[CL]}],
        xaxis:{categories:['Custo']},plotOptions:{bar:{columnWidth:'50%',endingShape:'rounded'}},colors:['#00214D','#FFB400'],dataLabels:{enabled:true,position:'top',style:{fontSize:'0.9rem',fontWeight:'500'}},grid:{borderColor:'#e0e0e0'},tooltip:{y:{formatter:v=>v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}}
      }).render();
      // Donut Chart
      ApexCharts.exec('donut-chart','destroy');
      new ApexCharts(document.querySelector('#chart-donut'),{
        chart:{id:'donut-chart',type:'donut',toolbar:{show:false}},
        series:[CL,juros],labels:['Capital LÃ­quido','Juros Totais'],colors:['#00214D','#FFB400'],legend:{position:'bottom'},dataLabels:{formatter:(val)=>val.toFixed(1)+'%'},plotOptions:{pie:{donut:{labels:{show:true,name:{show:true},value:{show:true,formatter:(val)=>val.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}}}}}
      }).render();
      // Mostrar resultados e grÃ¡ficos
      document.getElementById('resCard').classList.remove('hidden');
      document.getElementById('lineCard').classList.remove('hidden');
      document.getElementById('barCard').classList.remove('hidden');
      document.getElementById('donutCard').classList.remove('hidden');
    });
  </script>
</body>
</html>
